This repo contains demo application implementing advanced Universal Windows Platform (UWP) lifecycle patterns related to ["Launching, resuming, and background tasks"](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/index) MSDN section. Application is organized according to layered architecture using MVVM and Inversion-of-Control/Dependency-Inversion/Dependency-Injection.
# Universal Application architectural topics consideration
There are few important UWP topics that should be reviewed to make architectural decisions.
## UWP as Mobile-First application platform
Microsoft had a chance to build application platform from scratch to meet all potential requirements to mobile applications in XXI century. Developers and other users expect that "Windows 10" will be renamed to "Windows" (number less) and user will not have to buy next OS. That may happen when Win10 market share will reach over 1 billion of users. Windows 10S - is the sample of such free OS where you will pay only for store applications. It is nice to see that Microsoft has a good will to do such innovations. In different Win10 annual builds we see permanent progress in UWP evolution.  
UWP is very different than classic windows application. UWP as Win8-x/Win10 is part of Microsoft's "Mobile First and Cloud First" concept. UWP, as WinRT superset, has strong abstraction from core OS kernel process entity. In comparison to classic windows applications, API calls were referenced to WinRT interfaces. Theoretically, in next 5 years UWP may be ported to other OS platforms as Android.
## Lifecycle Start/Stop rethink
UWP, first of all, differs from other application kinds in its lifetime. Classic UWP application has started/stopping lifecycle points available for handling from process code. To understand UWP lifecycle you should forget everything that you knew about application lifecycle. Basically, UWP has [Not Running, Running and Suspended states](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/app-lifecycle). Additionally we may handle Foreground and Background states.

<img src=/docs/images/Lifecycle.PNG width=300 height=200 />

What did inspire Microsoft engineers to make such [lifecycle](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/app-lifecycle)? I may say that classic Windows/Unix application lifecycle invitation was inspired by some first electric equipment that could be turned ON or OFF. UWP lifecycle is something like lifecycle of human thoughts that exists in creative human head. They may be suspended if computer doesn't have enough resources (Battery or RAM) and be resumed later. When app moves to suspend it should release OS resources (like file handles) because process cannot know if it will be resumed at all. Win10 OS on different devices (Xbox or Desktop) and different builds (10.0 Build 10586, Anniversary Update - 10.0 Build 14393, eg.)  has different heuristic behavior to manage application lifecycle. Some Windows 10 versions may freeze and close process without suspension. Other OS versions may suspend, hibernate and reload your application after computer restart. UWP developer should carefully read all  ["Launching, resuming, and background tasks" MSDN section](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/index) and test different form factors and Win10 builds.
## Run while minimized with extended execution
[Extended execution](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/run-minimized-with-extended-execution) is related to application lifecycle but becomes separate serious topic in UWP application architecture. Extended execution is very important technique for any application logic that executes during one second and longer. Theoretically its usage is simple for basic case but there are many practical questions:
* Developer wants to write logic in the way maximally decoupled from extended execution session manner according to Dependency Inversion principle.
* Applications often have multiple parallel running processes. It incites developer to open two parallel extended execution sessions. However UWP allows requesting only one extended execution session in the same time. Attempt to open the second session before disposing the first one will rise `InvalidOperationException`.
* Application logic needs some flexible enough abstraction over single extended execution session. Application logic needs some manager that controls single extended execution session lifetime. Such manager should be able to host multiple tasks.
* Depending on windows battery charge, energy save mode enable, ["Battery usage by app"](http://www.howto-connect.com/customize-battery-usage-by-app-in-windows-10/) settings and other OS factors, application may call `RequestExtensionAsync()` method and get `ExtendedExecutionResult.Denied`. It doesn't mean that without extended execution application should not allow user to execution some regular long running context that may be denied or revoked after start.
* Every aggregated under extended execution manager task should be notified about shared extended execution session revoke and may handle such event in different ways:
  * Implement task cancellation using `CancellationToken`.
  * return from task's incremental long running loop.
  * notify user with toast notification and continue execution without suspension protection.
* End user knows nothing neither about sophisticated UWP lifecycle no about extended execution nuances. Regular user may change ["Battery usage by app"](http://www.howto-connect.com/customize-battery-usage-by-app-in-windows-10/) settings but that should not change foreground application execution user experience.

Developer should care about all these aspects if application may do some work after it was minimized.
## Free memory when your app moves to the background
Memory pleasure handling for me is advanced programming topic that was described in few good books like:
* Jeffrey Richter "Windows via C/C++" [book](https://www.amazon.com/Windows-via-Jeffrey-M-Richter/dp/0735624240/ref=sr_1_1?s=books&ie=UTF8&qid=1496045667&sr=1-1&keywords=windows+via+c%2Fc)
* Joe Duffy "Concurrent Programming on Windows" [book](https://www.amazon.com/Concurrent-Programming-Windows-Joe-Duffy/dp/032143482X/ref=asap_bc?ie=UTF8)
* Kalen Delaney "Microsoft SQL Server 2012 Internals" [book](https://www.amazon.com/Microsoft-Server-Internals-Developer-Reference-ebook/dp/B00JDMQJYC/ref=asap_bc?ie=UTF8)

In classic Win application when your application is under memory pleasure, you may start getting `OutOfMomoryExceptions`. Additionally, UWP application may be suspended after rising [MemoryManager](https://docs.microsoft.com/en-us/uwp/api/Windows.System.MemoryManager).`AppMemoryUsageLimitChanging` event during background execution. The best sample of application where such approach may be used is SQL Server (extremely complex software) where memory is allocated as blocks (extends) and managed in very advanced way. When we are developing much simpler UWP application that attempts to free resources to don’t be suspended, application handle such case:
* According to MSDN guidelines app may [unload some data and View Layer](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/reduce-memory-usage) if application is in background executions state.
* Try to avoid executing critical work sections in Mobile applications to avoid problems. It is natural for UWP application to be suspended/resumed and most of application tasks execution will not be harmed by suspend.
* Consider how your application layered architecture will work with releasing consumed RAM.

Idea of unloading View layers (setting windows content to null and сollecting all related memory) is very new. In UWP application View layer memory may be collected without [Application](https://docs.microsoft.com/en-us/uwp/api/Windows.UI.Xaml.Application) class instance with permanently live objects.
How real is such situation in real world mobile application? On the beginning of 2017 Microsoft releases new Surface Pro and Surface Laptop devices with 4GB RAM. It is very real that some student will run some heavy application like Auto Cad and your application RAM limit will be decreased to 250MB. Other, more frequent sample, is when Xbox runs some heavy game that takes maximum RAM and the box will allow your application be alive only if your application will take 100MB maximum. Does it makes sense for your application to stay alive with minimal amount of RAM? Sometimes YES when you are developing Skype competitor that should hold minimal communication with online server. If your application also requires lots of ram and is not designed to release majority of it and restore it later on the move to foreground, maybe, it will make sense to let Windows to suspend your app and store its RAM to the disk.
Anyway, there are few ways of what application can do when [MemoryManager](https://docs.microsoft.com/en-us/uwp/api/Windows.System.MemoryManager).`AppMemoryUsageLimitChanging` event will be riced with arguments warning about memory usage overflow:
* Ignore this fact and expect that application will be suspended and even terminated.
* Free some not required for minimal execution data controlled by Application Logic.
* Unload View level objects according to [Guidelines](https://docs.microsoft.com/en-us/windows/uwp/launch-resume/reduce-memory-usage).
